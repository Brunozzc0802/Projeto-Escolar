unit uFormEstudante;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Grids, Vcl.StdCtrls,
  uData, uModels, Vcl.ExtCtrls;

type
  TFormEstudante = class(TForm)
    sgEstudantes: TStringGrid;
    btnAdicionar: TButton;
    btnEditar: TButton;
    btnExcluir: TButton;
    btnAtualizar: TButton;
    procedure FormCreate(Sender: TObject);
    procedure btnAdicionarClick(Sender: TObject);
    procedure btnAtualizarClick(Sender: TObject);
    procedure btnExcluirClick(Sender: TObject);
    procedure btnEditarClick(Sender: TObject);
  private
    procedure AtualizarGrid;
  public
    { Public declarations }
  end;

var
  FormEstudante: TFormEstudante;

implementation

{$R *.dfm}

procedure TFormEstudante.FormCreate(Sender: TObject);
begin
  // configurações iniciais do grid
  sgEstudantes.RowCount := 2;
  sgEstudantes.ColCount := 2;
  sgEstudantes.Cells[0,0] := 'Código';
  sgEstudantes.Cells[1,0] := 'Nome';
  AtualizarGrid;
end;

procedure TFormEstudante.AtualizarGrid;
var
  i: Integer;
begin
  sgEstudantes.RowCount := DM.Estudantes.Count + 1;
  sgEstudantes.Cells[0,0] := 'Código';
  sgEstudantes.Cells[1,0] := 'Nome';
  for i := 0 to DM.Estudantes.Count - 1 do
  begin
    sgEstudantes.Cells[0, i+1] := IntToStr(DM.Estudantes[i].Codigo);
    sgEstudantes.Cells[1, i+1] := DM.Estudantes[i].Nome;
  end;
end;

procedure TFormEstudante.btnAdicionarClick(Sender: TObject);
var
  sCode, sName: string;
  code: Integer;
begin
  sCode := InputBox('Adicionar', 'Código:', '');
  if sCode = '' then Exit;
  if not TryStrToInt(sCode, code) then
  begin
    ShowMessage('Código inválido');
    Exit;
  end;
  if DM.CodigoEstudanteExiste(code) then
  begin
    ShowMessage('Código já existe.');
    Exit;
  end;
  sName := InputBox('Adicionar', 'Nome:', '');
  if Trim(sName) = '' then
  begin
    ShowMessage('Nome obrigatório');
    Exit;
  end;
  DM.Estudantes.Add(TEstudante.Create(code, sName));
  AtualizarGrid;
end;

procedure TFormEstudante.btnAtualizarClick(Sender: TObject);
begin
  AtualizarGrid;
end;

procedure TFormEstudante.btnExcluirClick(Sender: TObject);
var
  row, idx: Integer;
begin
  row := sgEstudantes.Row;
  if row < 1 then
  begin
    ShowMessage('Selecione um estudante.');
    Exit;
  end;
  idx := row - 1;
  if MessageDlg('Confirma excluir?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin
    // ver se estudante possui matrícula — valida referencial
    // percorre DM.Matriculas para garantir integridade
    var i: Integer;
    for i := 0 to DM.Matriculas.Count - 1 do
      if DM.Matriculas[i].CodigoEstudante = DM.Estudantes[idx].Codigo then
      begin
        ShowMessage('Impossível excluir: estudante possui matrícula.');
        Exit;
      end;

    DM.Estudantes.Delete(idx);
    AtualizarGrid;
  end;
end;

procedure TFormEstudante.btnEditarClick(Sender: TObject);
var
  row, idx, code: Integer;
  newName, sCode: string;
begin
  row := sgEstudantes.Row;
  if row < 1 then
  begin
    ShowMessage('Selecione um estudante.');
    Exit;
  end;
  idx := row - 1;
  sCode := InputBox('Editar', 'Código:', IntToStr(DM.Estudantes[idx].Codigo));
  if not TryStrToInt(sCode, code) then
  begin
    ShowMessage('Código inválido');
    Exit;
  end;
  // se alterou o código, valida duplicidade
  if (code <> DM.Estudantes[idx].Codigo) and DM.CodigoEstudanteExiste(code) then
  begin
    ShowMessage('Código já existe.');
    Exit;
  end;
  newName := InputBox('Editar', 'Nome:', DM.Estudantes[idx].Nome);
  if Trim(newName) = '' then
  begin
    ShowMessage('Nome obrigatório');
    Exit;
  end;

  // atualizar (atenção: se mudar código, garantir integridade matriculas)
  if code <> DM.Estudantes[idx].Codigo then
  begin
    // atualizar todas as matrículas que referenciam esse código
    var i: Integer;
    for i := 0 to DM.Matriculas.Count - 1 do
      if DM.Matriculas[i].CodigoEstudante = DM.Estudantes[idx].Codigo then
        DM.Matriculas[i].CodigoEstudante := code;
  end;

  DM.Estudantes[idx].Codigo := code;
  DM.Estudantes[idx].Nome := newName;
  AtualizarGrid;
end;

end.

